<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Guru - SMPN 13 Makassar</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --primary-color: #4e73df; 
            --secondary-color: #858796; 
            --bg-color: #f8f9fc;
            --sidebar-width: 260px;
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-color); 
            height: 100vh;
            overflow-x: hidden;
        }

        /* --- STYLE LOGIN PAGE (Glassmorphism) --- */
        #login-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-login {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            border: none;
        }

        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
            border-color: #4e73df;
        }

        /* --- STYLE DASHBOARD --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 1000;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .nav-link {
            padding: 15px 25px;
            color: #5a5c69;
            font-weight: 500;
            display: flex;
            align-items: center;
            border-left: 4px solid transparent;
            transition: 0.2s;
        }

        .nav-link:hover { background: #f8f9fa; color: var(--primary-color); }
        
        .nav-link.active {
            color: var(--primary-color);
            background: #f0f4ff;
            border-left: 4px solid var(--primary-color);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            transition: all 0.3s;
        }

        .card-module {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            background: #fff;
            transition: transform 0.2s;
        }
        
        .page-title { font-weight: 700; color: #4e73df; margin-bottom: 25px; }

        /* Badge Status */
        .badge-status {
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-pending { background: #eaecf4; color: #858796; }
        .badge-success { background: #d1fae5; color: #065f46; }

        /* Loader Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%; height: auto; bottom: 0; top: auto;
                display: flex; justify-content: space-around;
                padding: 10px; border-top: 1px solid #ddd;
            }
            .sidebar-header { display: none; }
            .main-content { margin-left: 0; padding-bottom: 80px; }
            .nav-link { flex-direction: column; font-size: 12px; padding: 5px; border-left: none; border-top: 3px solid transparent; }
            .nav-link.active { border-left: none; border-top: 3px solid var(--primary-color); }
            .nav-link span { display: block; margin-top: 5px; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3 fw-bold text-primary">Memproses Data...</p>
</div>

<div id="login-page">
    <div class="card-login">
        <div class="text-center mb-4">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                <i class="bi bi-mortarboard-fill fs-2"></i>
            </div>
            <h4 class="fw-bold text-dark">Portal Guru</h4>
            <p class="text-muted small">SMPN 13 Makassar</p>
        </div>
        
        <div class="form-group mb-3">
            <label class="form-label small fw-bold text-secondary">Email Address</label>
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-envelope text-primary"></i></span>
                <input type="email" id="email" class="form-control border-start-0 ps-0" placeholder="nama@guru.smp.belajar.id">
            </div>
        </div>

        <div class="form-group mb-4">
            <label class="form-label small fw-bold text-secondary">Password</label>
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-lock text-primary"></i></span>
                <input type="password" id="pass" class="form-control border-start-0 border-end-0 ps-0" placeholder="••••••••">
                <button class="btn btn-outline-secondary border-start-0 bg-white" type="button" onclick="togglePassword()">
                    <i class="bi bi-eye-slash" id="toggleIcon"></i>
                </button>
            </div>
        </div>

        <button class="btn btn-primary w-100 py-2 fw-bold rounded-pill shadow-sm mb-3" onclick="login()">
            MASUK APLIKASI
        </button>
        
        <div class="text-center">
            <a href="<?= ScriptApp.getService().getUrl() ?>?page=admin" class="text-decoration-none small text-muted hover-primary">
                <i class="bi bi-shield-lock me-1"></i> Login Administrator
            </a>
        </div>
    </div>
</div>

<div id="main-app" class="d-none">
    <nav class="sidebar">
        <div class="sidebar-header">
            <h5 class="fw-bold text-primary m-0"><i class="bi bi-grid-fill me-2"></i>DASHBOARD</h5>
            <small class="text-muted">Guru Panel</small>
        </div>
        <div class="nav flex-column mt-3">
            <a class="nav-link active" onclick="showPage('modulData', this)">
                <i class="bi bi-person-circle fs-5 me-2"></i> <span>Data Diri</span>
            </a>
            <a class="nav-link" onclick="showPage('modulBerkas', this)">
                <i class="bi bi-file-earmark-arrow-up fs-5 me-2"></i> <span>Upload Berkas</span>
            </a>
            <a class="nav-link" onclick="showPage('modulLink', this)">
                <i class="bi bi-link-45deg fs-5 me-2"></i> <span>Link Kegiatan</span>
            </a>
            <div class="mt-auto p-3">
                <button class="btn btn-danger w-100 rounded-pill" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-dark m-0">Selamat Datang, Guru!</h4>
                <p class="text-muted small m-0" id="user-email-display">user@email.com</p>
            </div>
            <div class="d-none d-md-block">
                <span class="badge bg-primary rounded-pill px-3 py-2">Tahun Ajaran 2025/2026</span>
            </div>
        </div>

        <div id="modulData" class="page animate-fade">
            <h5 class="page-title">Identitas Pegawai</h5>
            <div class="card card-module p-4">
                <div class="alert alert-primary d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                    <div class="small">Silakan periksa data Anda. Jika ada kesalahan, ubah dan klik tombol Simpan.</div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">Nama Lengkap & Gelar</label>
                        <input type="text" id="nama" class="form-control form-control-lg">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">NIP</label>
                        <input type="number" id="nip" class="form-control form-control-lg">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-secondary">Pangkat/Golongan</label>
                        <select id="pangkat" class="form-select">
                            <option value="">- Pilih -</option>
                            <option value="III/a">III/a</option><option value="III/b">III/b</option>
                            <option value="III/c">III/c</option><option value="III/d">III/d</option>
                            <option value="IV/a">IV/a</option><option value="IV/b">IV/b</option>
                            <option value="IV/c">IV/c</option><option value="IV/d">IV/d</option>
                            <option value="IX">PPPK (IX)</option><option value="II">Honorer</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-secondary">Tempat Lahir</label>
                        <input type="text" id="tmptLahir" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-secondary">Tanggal Lahir</label>
                        <input type="date" id="tglLahir" class="form-control">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold small text-secondary">Mata Pelajaran Utama</label>
                        <select id="mapel" class="form-select">
                            <option value="PAI">Pend.Agama Islam</option><option value="PAK">Pend.Agama Kristen</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option><option value="Bahasa Inggris">Bahasa Inggris</option>
                            <option value="Matematika">Matematika</option><option value="IPA">IPA</option><option value="PKN">PKN</option>
                            <option value="IPS">IPS</option><option value="PJOK">PJOK</option>
                            <option value="SBK">Seni Budaya</option><option value="Prakarya">Prakarya</option>
                            <option value="Informatika">Informatika</option><option value="Mulok">Mulok</option>
                            <option value="BK">Konseling</option><option value="TU">Tata Usaha</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 text-end">
                    <button class="btn btn-primary px-4 py-2 fw-bold rounded-pill" onclick="saveData()">
                        <i class="bi bi-save me-2"></i>SIMPAN PERUBAHAN
                    </button>
                </div>
            </div>
        </div>

        <div id="modulBerkas" class="page d-none animate-fade">
            <h5 class="page-title">Dokumen Digital</h5>
            <div class="row">
                <div class="col-md-5 mb-4">
                    <div class="card card-module p-4 h-100">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">Form Unggah</h6>
                        <label class="form-label small fw-bold">Jenis Dokumen</label>
                        <select id="jenis" class="form-select mb-3">
                            <option value="KK">Kartu Keluarga (KK)</option>
                            <option value="SK">SK Terakhir</option>
                            <option value="KGB">KGB Terakhir</option>
                            <option value="Foto">Foto Resmi</option>
                        </select>
                        <label class="form-label small fw-bold">Pilih File (PDF/JPG)</label>
                        <input type="file" id="fileInput" class="form-control mb-4">
                        <button class="btn btn-success w-100 fw-bold rounded-pill" onclick="uploadFile()">
                            <i class="bi bi-cloud-upload me-2"></i> MULAI UPLOAD
                        </button>
                    </div>
                </div>
                <div class="col-md-7 mb-4">
                    <div class="card card-module p-4 h-100">
                        <h6 class="fw-bold mb-3 border-bottom pb-2">Status Berkas Anda</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0">
                                <div><i class="bi bi-card-heading me-2 text-primary"></i> Kartu Keluarga</div>
                                <span id="status-KK" class="badge-status badge-pending">Belum Ada</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 bg-light rounded">
                                <div><i class="bi bi-file-earmark-text me-2 text-primary"></i> SK Terakhir</div>
                                <span id="status-SK" class="badge-status badge-pending">Belum Ada</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0">
                                <div><i class="bi bi-cash-coin me-2 text-primary"></i> KGB Terakhir</div>
                                <span id="status-KGB" class="badge-status badge-pending">Belum Ada</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 bg-light rounded">
                                <div><i class="bi bi-person-square me-2 text-primary"></i> Foto Resmi</div>
                                <span id="status-Foto" class="badge-status badge-pending">Belum Ada</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="modulLink" class="page d-none animate-fade">
            <h5 class="page-title">Laporan Link Drive</h5>
            <div class="card card-module p-4 mb-4">
                <div class="row align-items-end">
                    <div class="col-md-5 mb-3 mb-md-0">
                        <label class="form-label small fw-bold">Judul Kegiatan/Berkas</label>
                        <input type="text" id="jLink" class="form-control" placeholder="Contoh: Modul Ajar Genap">
                    </div>
                    <div class="col-md-5 mb-3 mb-md-0">
                        <label class="form-label small fw-bold">Link Google Drive</label>
                        <input type="url" id="uLink" class="form-control" placeholder="https://drive.google.com/...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-info text-white w-100 fw-bold rounded-pill" onclick="saveLink()">
                            <i class="bi bi-send-fill"></i> KIRIM
                        </button>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold mb-3 text-secondary">Riwayat Pengiriman</h6>
            <div class="card card-module overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small">
                            <tr>
                                <th class="py-3 ps-4">NAMA KEGIATAN</th>
                                <th class="py-3 text-end pe-4">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="history-links">
                            <tr><td colspan="2" class="text-center py-4 text-muted">Belum ada riwayat pengiriman</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0OqVHBP6lFlXXn36SB-cJ0hH4_RQ8iuRJUrKxN3MpM0opqoekjVGtnNIwtdZiWm9hKg/exec"; 
    let session = {};

    // Efek Transisi Halaman
    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
        const target = document.getElementById(id);
        target.classList.remove('d-none');
        
        // Animasi fade in sederhana
        target.style.opacity = 0;
        setTimeout(() => target.style.opacity = 1, 50);

        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    // Toggle Password Visibility
    function togglePassword() {
        const passInput = document.getElementById('pass');
        const icon = document.getElementById('toggleIcon');
        if (passInput.type === "password") {
            passInput.type = "text";
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        } else {
            passInput.type = "password";
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        }
    }

    function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }

    // Notifikasi SweetAlert yang Reusable
    function showNotif(type, title, text) {
        Swal.fire({
            icon: type,
            title: title,
            text: text,
            confirmButtonColor: '#4e73df',
            timer: type === 'success' ? 2000 : undefined
        });
    }

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('pass').value;
        if(!email || !password) return showNotif('warning', 'Peringatan', 'Mohon isi email dan password!');

        toggleLoader(true);
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email, password }) }).then(r => r.json());
            
            if (res.status === "success") {
                session = res;
                document.getElementById('user-email-display').innerText = session.email;
                
                await fetchGuruData(session.email);

                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-app').classList.remove('d-none');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Login Berhasil',
                    text: 'Selamat datang kembali!',
                    showConfirmButton: false,
                    timer: 1500,
                    backdrop: `rgba(0,0,123,0.4)`
                });
            } else {
                showNotif('error', 'Login Gagal', res.message);
            }
        } catch (e) {
            showNotif('error', 'Error', 'Terjadi kesalahan koneksi.');
        }
        toggleLoader(false);
    }

    async function fetchGuruData(email) {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getGuruData', email }) }).then(r => r.json());
        
        if(res.status === 'success') {
            // Isi Form Profil
            if(res.profil) {
                document.getElementById('nama').value = res.profil.nama || "";
                document.getElementById('nip').value = res.profil.nip || "";
                document.getElementById('pangkat').value = res.profil.pangkat || "";
                document.getElementById('tmptLahir').value = res.profil.tmptLahir || "";
                document.getElementById('tglLahir').value = res.profil.tglLahir || "";
                document.getElementById('mapel').value = res.profil.mapel || "";
            }

            // Update Status Berkas (UI Baru)
            const updateBadge = (id, url) => {
                const el = document.getElementById(id);
                if(url) {
                    el.innerHTML = `<a href="${url}" target="_blank" class="text-decoration-none text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Selesai (Lihat)</a>`;
                    el.className = "badge-status badge-success";
                } else {
                    el.innerText = "Belum Ada";
                    el.className = "badge-status badge-pending";
                }
            };
            updateBadge('status-KK', res.berkas.KK);
            updateBadge('status-SK', res.berkas.SK);
            updateBadge('status-KGB', res.berkas.KGB);
            updateBadge('status-Foto', res.berkas.Foto);

            // Update History Link
            const tbody = document.getElementById('history-links');
            if(res.links.length > 0) {
                tbody.innerHTML = "";
                res.links.forEach(l => {
                    tbody.innerHTML += `
                    <tr>
                        <td class="ps-4 fw-bold text-dark">${l.judul}</td>
                        <td class="text-end pe-4"><a href="${l.url}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-3">Buka Link</a></td>
                    </tr>`;
                });
            }
        }
    }

    async function saveData() {
        const data = { 
            email: session.email, 
            nama: document.getElementById('nama').value, 
            nip: document.getElementById('nip').value, 
            pangkat: document.getElementById('pangkat').value, 
            tmptLahir: document.getElementById('tmptLahir').value, 
            tglLahir: document.getElementById('tglLahir').value, 
            mapel: document.getElementById('mapel').value 
        };
        toggleLoader(true);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'simpanData', data }) }).then(r => r.json());
        toggleLoader(false);
        
        if(res.status === 'success') showNotif('success', 'Berhasil', res.message);
        else showNotif('error', 'Gagal', res.message);
    }

    function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        const jenis = document.getElementById('jenis').value;
        if (!file) return showNotif('warning', 'File Kosong', 'Silakan pilih file PDF atau JPG!');
        
        toggleLoader(true);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'upload', base64: reader.result, fileName: file.name, email: session.email, jenis }) 
            }).then(r => r.json());
            
            toggleLoader(false);
            if(res.status === 'success') {
                showNotif('success', 'Terupload', res.message);
                fetchGuruData(session.email);
            } else {
                showNotif('error', 'Gagal', res.message);
            }
        };
    }

    async function saveLink() {
        const j = document.getElementById('jLink').value;
        const u = document.getElementById('uLink').value;
        if(!j || !u) return showNotif('warning', 'Data Kurang', 'Judul dan Link wajib diisi!');

        toggleLoader(true);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'simpanLink', data: { email: session.email, judul: j, link: u } }) }).then(r => r.json());
        toggleLoader(false);

        if(res.status === 'success') {
             showNotif('success', 'Terkirim', res.message);
             document.getElementById('jLink').value = "";
             document.getElementById('uLink').value = "";
             fetchGuruData(session.email);
        } else {
            showNotif('error', 'Gagal', res.message);
        }
    }

    function logout() {
        Swal.fire({
            title: 'Keluar Aplikasi?',
            text: "Sesi Anda akan diakhiri.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Logout'
        }).then((result) => {
            if (result.isConfirmed) {
                location.reload();
            }
        })
    }
</script>
</body>
</html>
