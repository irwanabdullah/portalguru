<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Guru - SMPN 13 Makassar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
    :root { --dark: #1e293b; --primary: #0d6efd; --bg: #f1f5f9; }
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; background: var(--bg); font-family: 'Inter', sans-serif; overflow-x: hidden; }
    .content-wrapper { flex: 1 0 auto; }
    
    /* Login Page Mobile Friendly */
    #login-page { min-height: 85vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    
    /* Sidebar Responsive */
    .sidebar { background: var(--dark); color: white; min-height: 100vh; transition: 0.3s; z-index: 1050; }
    .nav-link { color: #94a3b8; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; padding: 12px 15px; }
    .nav-link.active, .nav-link:hover { background: #334155; color: white; }
    
    /* Stats Cards */
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .stats-card { border-left: 5px solid var(--primary); background: white; padding: 15px; border-radius: 12px; height: 100%; }
    
    /* Loader */
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
    
    /* Mobile Overlay */
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1040; }

    @media (max-width: 768px) { 
        .sidebar { position: fixed; left: -100%; width: 280px; } 
        .sidebar.show { left: 0; }
        .sidebar-overlay.show { display: block; }
        main { width: 100% !important; padding: 15px !important; }
        .btn-group-mobile { display: flex; flex-direction: column; gap: 5px; }
    }
	
	footer {
    text-align: center; /* Mengetengahkan teks */
    padding: 20px;
    background: white;
    border-top: 1px solid #e2e8f0;
    width: 100%;
    flex-shrink: 0; /* Memastikan footer tidak mengecil */
    font-size: 0.9rem;
    color: #64748b;
}

	body { 
    display: flex; 
    flex-direction: column; 
    min-height: 100vh; /* Pastikan tinggi minimal memenuhi layar */
    background: var(--bg); 
    font-family: 'Inter', sans-serif; 
    overflow-x: hidden; 
}

.content-wrapper { 
    flex: 1 0 auto; /* Ini yang mendorong footer ke bawah */
}

	</style>
</head>
<body oncontextmenu="return false;">

<div id="loader"><div class="spinner-border text-primary"></div><p class="mt-2 fw-bold">Memproses...</p></div>

<div class="content-wrapper">
    <div id="login-page" class="container">
        <div class="card p-4 mx-auto shadow-lg border-0" style="max-width: 400px; width: 100%;">
            <div class="text-center mb-4">
                <i class="bi bi-person-circle text-primary" style="font-size: 3.5rem;"></i>
                <h4 class="fw-bold mt-2">LOGIN PORTAL</h4>
                <p class="text-muted small">SMPN 13 MAKASSAR</p>
            </div>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email">
            <input type="password" id="pass" class="form-control mb-4" placeholder="Password">
            <button class="btn btn-primary w-100 py-2 fw-bold shadow" onclick="login()">MASUK SISTEM</button>
        </div>
    </div>

    <div id="main-app" class="container-fluid d-none">
		<div class="d-md-none bg-white p-3 shadow-sm d-flex justify-between align-items-center mb-3">
			<button class="btn btn-dark" onclick="toggleSidebar()">
        <i class="bi bi-list"></i> Menu
			</button>
		<span class="fw-bold text-primary">PORTAL GURU</span>
		</div>

		<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <div class="row">
            <nav class="col-md-2 sidebar p-3" id="sidebarMenu">
                <div class="text-center py-4 border-bottom border-secondary mb-3"><h5 class="fw-bold text-info">E-DATA GURU</h5></div>
                <div class="nav flex-column">
                    <a class="nav-link active" onclick="showPage('modulData', this)"><i class="bi bi-person-badge me-2"></i> Identitas Diri</a>
                    <a class="nav-link" onclick="showPage('modulBerkas', this)"><i class="bi bi-cloud-arrow-up me-2"></i> Unggah Berkas</a>
                    <a class="nav-link" onclick="showPage('modulLink', this)"><i class="bi bi-link-45deg me-2"></i> Link Drive</a>
                    <div id="admin-only" class="d-none mt-4 pt-3 border-top border-secondary">
                        <small class="text-muted px-2 d-block mb-2">ADMIN PANEL</small>
                        <a class="nav-link text-warning" onclick="showPage('modulAdmin', this); fetchAdminData('guru')"><i class="bi bi-speedometer2 me-2"></i> Dashboard Admin</a>
                    </div>
                    <a class="nav-link text-danger mt-5" onclick="location.reload()"><i class="bi bi-power me-2"></i> Logout</a>
                </div>
            </nav>

            <main class="col-md-10 p-4">
                <div id="modulData" class="page">
                    <h3 class="fw-bold mb-4 text-primary">Profil Guru</h3>
                    <div class="card p-4">
                        <div class="row g-3">
                            <div class="col-md-6"><label class="small fw-bold">Nama Lengkap</label><input type="text" id="nama" class="form-control" placeholder="Contoh: Dr. Abdullah, M.Pd.,S.Pd"></div>
                            <div class="col-md-6"><label class="small fw-bold">NIP</label><input type="text" id="nip" class="form-control" placeholder="16 Angka"></div>
                            <div class="col-md-4"><label class="small fw-bold">Pangkat/Golongan</label>
                                <select id="pangkat" class="form-select">                                    
									<option value="III/a">III/a</option>
									<option value="III/b">III/b</option>
									<option value="III/c">III/c</option>
									<option value="III/d">III/d</option>
                                    <option value="IV/a">IV/a</option>
									<option value="IV/b">IV/b</option>
									<option value="IV/c">IV/c</option>
									<option value="IV/d">IV/d</option>
									<option value="IX">IX</option>
									<option value="II">II</option>
                                </select>
                            </div>
                            <div class="col-md-4"><label class="small fw-bold">Tempat Lahir</label><input type="text" id="tmptLahir" class="form-control" placeholder="Makassar"></div>
                            <div class="col-md-4"><label class="small fw-bold">Tgl Lahir</label><input type="date" id="tglLahir" class="form-control"></div>
                            <div class="col-md-12"><label class="small fw-bold">Mata Pelajaran/Job Desk</label>
                                <select id="mapel" class="form-select">
                                    <option value="PAI">Pend.Agama Islam</option>
									<option value="PAK">Pend.Agama Kristen</option>
									<option value="Bahasa Indonesia">Bahasa Indonesia</option>
									<option value="Bahasa Inggris">Bahasa Inggris</option>
                                    <option value="Matematika">Matematika</option>
									<option value="IPA">IPA</option>
									<option value="IPS">IPS</option>
                                    <option value="PJOK">PJOK</option>
									<option value="SBK">Seni Budaya</option>
									<option value="Prakarya">Prakarya</option>
									<option value="Informatika">Informatika</option>
									<option value="Mulok">Mulok</option>
									<option value="BK">Konseling</option>
									<option value="Lainnya">TU</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary mt-4 fw-bold shadow-sm" onclick="saveData()">SIMPAN DATA</button>
                    </div>
                </div>

                <div id="modulAdmin" class="page d-none">
					<h3 class="fw-bold mb-4 text-danger">Monitoring Dashboard</h3>
					
					<div class="row g-3 mb-4">
						<div class="col-6 col-md-4">
							<div class="stats-card shadow-sm"><small class="text-muted fw-bold">GURU</small><h3 id="stat-total" class="fw-bold mb-0">0</h3></div>
						</div>
						<div class="col-6 col-md-4">
							<div class="stats-card shadow-sm" style="border-left-color: #198754;"><small class="text-muted fw-bold">BERKAS</small><h3 id="stat-berkas" class="fw-bold mb-0">0</h3></div>
						</div>
					</div>

					<div class="card p-3 mb-3 shadow-sm">
						<div class="row g-3 align-items-center">
							<div class="col-12 col-lg-5">
								<div class="btn-group w-100">
									<button class="btn btn-outline-dark btn-sm" onclick="fetchAdminData('guru')">Guru</button>
									<button class="btn btn-outline-dark btn-sm" onclick="fetchAdminData('berkas')">Berkas</button>
									<button class="btn btn-outline-dark btn-sm" onclick="fetchAdminData('link')">Link</button>
								</div>
							</div>
							<div class="col-8 col-lg-4"><input type="text" id="search" class="form-control form-control-sm" placeholder="Cari..." onkeyup="filterTable()"></div>
							<div class="col-4 col-lg-3 text-end"><button class="btn btn-success btn-sm w-100 fw-bold" onclick="exportExcel()"><i class="bi bi-file-excel"></i></button></div>
						</div>
					</div>
				</div>

                    <div class="card overflow-hidden shadow-sm">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="adminTable">
                                <thead class="table-primary small text-uppercase"><tr id="tHead"></tr></thead>
                                <tbody id="tBody" class="small"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="modulBerkas" class="page d-none">
                    <h3 class="fw-bold mb-4 text-primary">Upload Berkas</h3>
                    <div class="card p-4 shadow-sm border-0">
                        <select id="jenis" class="form-select mb-3"><option value="KK">Kartu Keluarga (KK)</option><option value="SK">SK Terakhir</option><option value="KGB">KGB Terakhir</option><option value="Foto">Foto Resmi</option></select>
                        <input type="file" id="fileInput" class="form-control mb-3"><button class="btn btn-primary fw-bold w-100" onclick="uploadFile()">UNGGAH FILE</button>
                    </div>
                </div>
                <div id="modulLink" class="page d-none">
                    <h3 class="fw-bold mb-4 text-primary">Kirim Link Google Drive</h3>
                    <div class="card p-4 shadow-sm border-0">
                        <input type="text" id="jLink" class="form-control mb-3" placeholder="Link EKinerja_NamaGuru"><input type="url" id="uLink" class="form-control mb-3" placeholder="https://drive.google.com/..."><button class="btn btn-info text-white fw-bold w-100" onclick="saveLink()">KIRIM LINK</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<footer>&copy; <span id="year"></span> | <a href="https://smpn13makassar.my.id" target="_blank" style="text-decoration:none; font-weight:bold;">SMPN 13 MAKASSAR</a></footer>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzY62nz6JVosElWP1O0OFWdybMssEco9spugXugn4FX_lFrJCQwdU9zeNAgFnpa9MU--Q/exec"; // GANTI DENGAN URL DEPLOY ANDA
    let session = {};
    document.getElementById('year').innerText = new Date().getFullYear();

    function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
        document.getElementById(id).classList.remove('d-none');
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('pass').value;
    toggleLoader(true);
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email, password }) }).then(r => r.json());
    
    if (res.status === "success") {
        session = res;
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-app').classList.remove('d-none');
        if (res.role === 'admin') document.getElementById('admin-only').classList.remove('d-none');
        showPage('modulData', document.querySelector('.nav-link'));
        
        // SweetAlert Sukses
        Swal.fire({ icon: 'success', title: 'Berhasil Login', text: 'Selamat datang di Portal Guru!', timer: 2000, showConfirmButton: false });
    } else {
        // SweetAlert Gagal
        Swal.fire({ icon: 'error', title: 'Login Gagal', text: 'Email atau Password Salah!' });
    }
    toggleLoader(false);
	}

    async function saveData() {
        const data = { email: session.email, nama: document.getElementById('nama').value, nip: document.getElementById('nip').value, pangkat: document.getElementById('pangkat').value, tmptLahir: document.getElementById('tmptLahir').value, tglLahir: document.getElementById('tglLahir').value, mapel: document.getElementById('mapel').value };
        toggleLoader(true);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'simpanData', data }) }).then(r => r.json());
        alert(res.message); toggleLoader(false);
    }

    function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        const jenis = document.getElementById('jenis').value;
        if (!file) return alert("Pilih file!");
        toggleLoader(true);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'upload', base64: reader.result, fileName: file.name, email: session.email, jenis }) }).then(r => r.json());
            alert(res.message); toggleLoader(false);
        };
    }

    async function saveLink() {
        const data = { email: session.email, judul: document.getElementById('jLink').value, link: document.getElementById('uLink').value };
        toggleLoader(true);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'simpanLink', data }) }).then(r => r.json());
        alert(res.message); toggleLoader(false);
    }

    async function fetchAdminData(type) {
        toggleLoader(true);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllData' }) }).then(r => r.json());
        document.getElementById('stat-total').innerText = res.guru.length - 1;
        document.getElementById('stat-berkas').innerText = res.berkas.length - 1;
        const th = document.getElementById('tHead'); const tb = document.getElementById('tBody');
        th.innerHTML = ""; tb.innerHTML = "";
        
        if (type === 'guru') {
            th.innerHTML = "<th>Nama</th><th>NIP</th><th>Pangkat</th><th>TTL</th><th>Mapel</th><th>Aksi</th>";
            res.guru.slice(1).forEach(r => {
                tb.innerHTML += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}, ${r[5]}</td><td>${r[6]}</td><td><button class="btn btn-outline-danger btn-sm border-0" onclick="hapusData('${r[0]}', 'guru')"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        } else if (type === 'berkas') {
            th.innerHTML = "<th>Email</th><th>KK</th><th>SK</th><th>KGB</th><th>Foto</th><th>Aksi</th>";
            res.berkas.slice(1).forEach(r => {
                const view = (l) => l ? `<a href="${l}" target="_blank" class="btn btn-sm btn-link"><i class="bi bi-eye"></i></a>` : '-';
                tb.innerHTML += `<tr><td>${r[0]}</td><td>${view(r[1])}</td><td>${view(r[2])}</td><td>${view(r[3])}</td><td>${view(r[4])}</td><td><button class="btn btn-outline-danger btn-sm border-0" onclick="hapusData('${r[0]}', 'berkas')"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        } else if (type === 'link') {
            th.innerHTML = "<th>Email</th><th>Judul</th><th>Link</th><th>Aksi</th>";
            res.kegiatan.slice(1).forEach(r => {
                tb.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td><td><a href="${r[2]}" target="_blank" class="btn btn-sm btn-info text-white fw-bold">Buka</a></td><td><button class="btn btn-outline-danger btn-sm border-0" onclick="hapusData('${r[0]}', 'link')"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        }
        toggleLoader(false);
    }

    async function hapusData(email, context) {
        if(!confirm(`Hapus data ${context} untuk ${email}?`)) return;
        toggleLoader(true);
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'hapusData', email, context }) });
        fetchAdminData(context === 'link' ? 'link' : (context === 'berkas' ? 'berkas' : 'guru'));
        toggleLoader(false);
    }

    function filterTable() {
        let input = document.getElementById("search").value.toLowerCase();
        let rows = document.getElementById("tBody").getElementsByTagName("tr");
        for (let row of rows) { row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none"; }
    }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById("adminTable"));
        XLSX.writeFile(wb, "Data_SMPN13_Update.xlsx");
    }
	
	// Fungsi Toggle Sidebar Mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebarMenu');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
    }

    // Modifikasi fungsi showPage agar otomatis menutup sidebar di mobile
    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
        document.getElementById(id).classList.remove('d-none');
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        
        // Tutup sidebar jika dalam mode mobile
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
    }
	
</script>
</body>
</html>
